<!DOCTYPE html>
<!-- 
    Open a browser debugging instruction to see the messages passing on the RPi
mosquitto_sub -h raspberrypi.local -t ohmpi_0001/soh
-->
<html>

<head>
  <meta charset="utf8" />
  <title>OhmPi Acquisition Board</title>
  <link rel="shortcut icon" type="image/jpg" href="logo_ohmpi.jpg" />

  <!-- dependencies (need to be local as no internet in AP mode)-->
  <script src="js/plotly-2.26.0.min.js"></script>
  <script src="js/jquery-3.7.1.min.js"></script>
  <link type="text/css" href="css/bootstrap.min.css" rel="stylesheet">
  <script src="js/paho/paho-mqtt.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <div class='container-fluid'>
    <h1>OhmPi Web Acquisition</h1>

    <div id="hwErrorAlert" class="alert alert-danger" style="display: none;" role="alert">
      An hardware error was encountered, the OhmPi cannot start.
      Power off the OhmPi, fix the error and power it on again.
      <div id="hwErrorLog">

      </div>
    </div>

    <!-- first set of buttons -->
    <button id="update_settingsBtn" type="button" class="btn btn-secondary" data-bs-toggle="modal"
      data-bs-target="#settingModal">Settings</button>
    <button id="runBtn" type="button" class="btn btn-primary">&#9654</button>
    <button id="stopBtn" type="button" class="btn btn-warning">&#9724</button>
    <button id="getDataBtn" type="button" class="btn btn-info">Get data</button>
    <button id="downloadModalBtn" type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#rmModal">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download"
        viewBox="0 0 16 16">
        <path
          d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5" />
        <path
          d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z" />
      </svg>
    </button>
    <button id="connectBtn" type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#mqttModal">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-lock"
        viewBox="0 0 16 16">
        <path
          d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56" />
        <path
          d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415" />
      </svg>
    </button>

    <!-- status indicators -->
    <div><b id="connection">Connecting...</b></div>
    <div id="output">Status: idle</div>

    <div class="form-check">
      <input id="dataRetrievalCheck" class="form-check-input" type="checkbox" value="">
      <label class="form-check-label" for="dataRetrievalCheck">
        Show live data.
      </label>
    </div>

    <!-- main figures presented inside an accordion -->
    <div class="accordion" id="accordion-alwaysOpen">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelPseudo"
            aria-expanded="true" aria-controls="panelPseudo">
            Pseudo-section
          </button>
        </h2>

        <!-- pseudo-section -->
        <div id="panelPseudo" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <div class="row gx-1">
              <div class="col-auto">
                <select id="surveySelect" class="form-select"></select>
              </div>
              <div class="col-auto">
                <select id="attrSelect" class="form-select">
                  <option value="app">Apparent resistivity [Ohm.m]</option>
                  <option value="r">Transfer resistance [Ohm]</option>
                  <option value="dev">Standard deviation [%]</option>
                  <option value="i">Current [mA]</option>
                  <option value="v">Voltage [mV]</option>
                </select>
              </div>
              <div class="col-auto">
                <div class="input-group">
                  <span class="input-group-text" id="cminLabel">Min:</span>
                  <input type="number" id="cmin" class="form-control" aria-label="cmin">
                </div>
                <!-- <input id="cmin" type="number" class="form-control-number" value="" placeholder="Min" /> -->
              </div>
              <div class="col-auto">
                <div class="input-group">
                  <span class="input-group-text" id="cmaxLabel">Max:</span>
                  <input type="number" id="cmax" class="form-control" aria-label="cmax">
                </div>
              </div>
              <div class="col-auto">
                <select id="cmap" class="form-select">
                  <option value="Viridis">Viridis</option>
                  <option value="Electric">Electric</option>
                  <option value="Cividis">Cividis</option>
                  <option value="Jet">Jet</option>
                  <option value="Hot">Hot</option>
                  <option value="Greys">Greys</option>
                  <option value="RdBu">RdBu</option>
                </select>
              </div>
              <div class="col-auto">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="logCheck">
                  <label class="form-check-label" for="logCheck">
                    log10
                  </label>
                </div>
              </div>
              <!-- <div class="col-auto">
                <button id="capplyBtn" type="button" class="btn btn-info">Apply</button>
              </div> -->
            </div>
            <div id="gd"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelTable"
            aria-expanded="false" aria-controls="panelTable">
            Table
          </button>
        </h2>
        <div id="panelTable" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- table of raw data -->
            <select id="surveyTableSelect" class="form-select"></select>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">A</th>
                  <th scope="col">B</th>
                  <th scope="col">M</th>
                  <th scope="col">N</th>
                  <th scope="col">Vmn [mV]</th>
                  <th scope="col">Iab [mA]</th>
                  <th scope="col">R [Ohm]</th>
                  <th scope="col">R std [%]</th>
                  <th scope="col">App [Ohm.m]</th>
                </tr>
              </thead>
              <tbody id="rawTable"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#panelTrace" aria-expanded="false" aria-controls="panelTrace">
            Time traces
          </button>
        </h2>
        <div id="panelTrace" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- trace figure -->
            <div class="row gx-1">
              <div class="col-auto">
                <label for="quadSelect">Quadrupole:</label>
              </div>
              <div class="col-auto">
                <select id='quadSelect' class='form-select'></select>
              </div>
              <div class="col-auto">
                <select id="attrSelectTrace" class="form-select">
                  <option value="app">Apparent resistivity [Ohm.m]</option>
                  <option value="r">Transfer resistance [Ohm]</option>
                  <option value="dev">Standard deviation [%]</option>
                  <option value="i">Current [mA]</option>
                  <option value="v">Voltage [mV]</option>
                </select>  
              </div>
              <div class="col-auto">
                <button id="addTraceBtn" type="button" class="btn btn-info">Add trace</button>
              </div>
              <div class="col-auto">
                <button id="removeTracesBtn" type="button" class="btn btn-info">Remove all traces</button>
              </div>
            </div>
            <div id="ts"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelRS"
            aria-expanded="false" aria-controls="panelRS">
            Resistance check
          </button>
        </h2>
        <div id="panelRS" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- RS check -->
            <button id="rsBtn" type="button" class="btn btn-info">Check contact resistance</button>
            <button id="rsClearBtn" type="button" class="btn btn-info">Clear plot</button>
            <div id="rs"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelFW"
            aria-expanded="false" aria-controls="panelFW">
            Full-waveform
          </button>
        </h2>
        <div id="panelFW" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- full waveform-->
            <p>By default, full-waveform data are not downloaded. Press the button below to donwload them. This can take several minutes. Look at the status (top of this dashboard).</p>
            <button id="getDataFWBtn" type="button" class="btn btn-info">Get full-waveform data</button>
            <div class="row gx-1">
              <div class="col-auto">
                <select id="surveyFWSelect" class='form-select'></select>
              </div>
              <div class="col-auto">
                <select id="quadFWSelect" class='form-select'></select>
              </div>
            </div>
            <p id="fwValues"></p>
            <!-- <button id="applyFWBtn" type="button" class="btn btn-info">Apply</button> -->
            <div id="fw"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelInv"
            aria-expanded="false" aria-controls="panelInv">
            Inversion
          </button>
        </h2>
        <div id="panelInv" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- Inversion plot -->
            <div class="row gx-1">
              <div class="col-auto">
                <select id="surveySelectInv" class='form-select'></select>
              </div>
              <div class="col-auto">
                <button id="invertBtn" type="button" class="btn btn-info">Run inversion</button>
              </div>
              <div class="col-auto">
                <div class="input-group">
                  <span class="input-group-text" id="cminInvLabel">Min:</span>
                  <input type="number" id="cminInv" class="form-control" aria-label="cminInv">
                </div>
              </div>
              <div class="col-auto">
                <div class="input-group">
                  <span class="input-group-text" id="cmaxInvLabel">Min:</span>
                  <input type="number" id="cmaxInv" class="form-control" aria-label="cmaxInv">
                </div>
              </div>
              <div class="col-auto">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="logInvCheck">
                  <label class="form-check-label" for="logInvCheck">
                    log10
                  </label>
                </div>  
              </div>
              <div class="col-auto">
                <select id="cmapInv" class="form-select">
                  <option value="Viridis">Viridis</option>
                  <option value="Electric">Electric</option>
                  <option value="Cividis">Cividis</option>
                  <option value="Jet">Jet</option>
                  <option value="Hot">Hot</option>
                  <option value="Greys">Greys</option>
                  <option value="RdBu">RdBu</option>
                </select>
              </div>
            </div>
            <p id="invOutput">Inversion success/failure will appear here.</p>
            <div id="inv"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelLog"
            aria-expanded="false" aria-controls="panelLog">
            Logs
          </button>
        </h2>
        <div id="panelLog" class="accordion-collapse collapse">
          <div class="accordion-body">
            <!-- log -->
            <nav>
              <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-1-tab" data-bs-toggle="tab" data-bs-target="#nav-1" type="button" role="tab" aria-controls="nav-1" aria-selected="true">Exec</button>
                <button class="nav-link" id="nav-2-tab" data-bs-toggle="tab" data-bs-target="#nav-2" type="button" role="tab" aria-controls="nav-2" aria-selected="false">Data</button>
                <button class="nav-link" id="nav-3-tab" data-bs-toggle="tab" data-bs-target="#nav-3" type="button" role="tab" aria-controls="nav-3" aria-selected="false">Ctrl</button>
                <button class="nav-link" id="nav-4-tab" data-bs-toggle="tab" data-bs-target="#nav-4" type="button" role="tab" aria-controls="nav-4" aria-selected="false">SOH</button>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active" id="nav-1" role="tabpanel" aria-labelledby="nav-1-tab">
                <textarea class="form-control" id="execlog" rows="10" readonly></textarea>
              </div>
              <div class="tab-pane fade" id="nav-2" role="tabpanel" aria-labelledby="nav-2-tab">
                <textarea class="form-control" id="datalog" rows="10" readonly></textarea>
              </div>
              <div class="tab-pane fade" id="nav-3" role="tabpanel" aria-labelledby="nav-3-tab">
                <textarea class="form-control" id="ctrllog" rows="10" readonly></textarea>
              </div>
              <div class="tab-pane fade" id="nav-4" role="tabpanel" aria-labelledby="nav-4-tab">
                <textarea class="form-control" id="sohlog" rows="10" readonly></textarea>
              </div>
            </div>            
          </div>
        </div>
      </div>
    </div>

    <!-- Additional buttons -->
    <a id="download"></a> <!-- used to create automatic download from .zip-->
    <button id="restartBtn" type="button" class="btn btn-danger">Restart</button>
    <button id="shutdownBtn" type="button" class="btn btn-danger">Shutdown</button>
    <button id="setTimeBtn" type="button" , class="btn btn-secondary">Set Time</button>

    <!-- Modal for connection to MQTT server -->
    <div class="modal fade" id="mqttModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false"
      aria-labelledby="settingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="connection">Connect to OhmPi via MQTT</h5>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3 row">
                <label for="mqttHostname" class="col-sm-2 col-form-label">MQTT server</label>
                <div class="col-sm-10">
                  <input id="mqttHostname" class="form-control" type="text" value="" />
                </div>
              </div>
              <div class="mb-3 row">
                <label for="mqttPort" class="col-sm-2 col-form-label">MQTT port</label>
                <div class="col-sm-10">
                  <input id="mqttPort" class="form-control-number" type="number" value=9001 />
                </div>
              </div>
              <div class="mb-3 row">
                <label for="mqttClientId" class="col-sm-2 col-form-label">Client ID:</label>
                <div class="col-sm-10">
                  <input id="mqttClientId" class="form-control" type="text" value="ohmpi_0001_html"/>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="mqttTopic" class="col-sm-2 col-form-label">Topic: </label>
                <div class="col-sm-10">
                  <input id="mqttTopic" class="form-control" type="text" value="ohmpi_0001" />
                </div>
              </div>
              <div class="mb-3 row">
                <label for="mqttUser" class="col-sm-2 col-form-label">Username:</label>
                <div class="col-sm-10">
                  <input id="mqttUser" class="form-control" type="text" value="mqtt_user"/>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="mqttPwd" class="col-sm-2 col-form-label">Password:</label>
                <div class="col-sm-10">
                  <input id="mqttPwd" class="form-control" type="password" value="mqtt_password"/>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="mqttConnectBtn" type="button" class="btn btn-primary" data-bs-dismiss="modal">Connect</button>
          </div>
        </div>
      </div>
    </div>

    <!-- setting modal-->
    <div class="modal fade" id="settingModal" tabindex="-1" aria-labelledby="settingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fs-5" id="settingModalLabel">Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="accordion" id="settingAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    Sequence
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                  data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <p>Upload a sequence as .txt with just 4 columns (A, B, M, N) without header, separated by 1 space.
                    </p>
                    <form class="form-group">
                      <div class="form-group row">
                        <label for="sequence" class="col-sm-2 col-form-label">Sequence</label>
                        <div class="col-sm-10">
                          <input type="file" class="form-control" id="sequence">
                        </div>
                      </div>
                    </form>
                    <!-- <button id="viewSeqBtn" class="btn btn-info">View sequence</button> -->
                    <hr>
                    <p>Create a sequence and add its parameter</p>
                    <form>
                      <div class="mb-3 row">
                        <label for="seqTypeSelect" class="col-sm-2 col-form-label">Type:</label>
                        <div class="col-sm-10">
                          <select id="seqTypeSelect" class="form-control">
                            <option value="wenner" selected=true>Wenner</option>
                            <option value="dpdp">Dipole-Dipole</option>
                            <option value="schlum">Schlumberger</option>
                            <option value="gradient">Gradient</option>
                          </select>
                        </div>
                      </div>
                      <div class="mb-3 row">
                        <label for="seqNelec" class="col-sm-2 col-form-label">Nb. Elec.</label>
                        <div class="col-sm-10">
                          <input id="seqNelec" class="form-control-number" type="number" placeholder="Number of electrodes"/>
                        </div>
                      </div>
                      <div class="mb-3 row">
                        <label for="seqParamA" class="col-sm-2 col-form-label">a:</label>
                        <div class="col-sm-10">
                          <input id="seqParamA" class="form-control-number" type="number" />
                        </div>
                      </div>
                      <div class="mb-3 row">
                        <label for="seqParamN" class="col-sm-2 col-form-label">n:</label>
                        <div class="col-sm-10">
                          <input id="seqParamN" class="form-control-number" type="number" disabled/>
                        </div>
                      </div>
                      <div class="mb-3 row">
                        <label for="seqParamS" class="col-sm-2 col-form-label">s:</label>
                        <div class="col-sm-10">
                          <input id="seqParamS" class="form-control-number" type="number" disabled />
                        </div>
                      </div>
                    </form>
                    <button id="seqGenerateBtn" class="btn btn-info">Generate</button>
                    <hr>
                    <p>Sequence used</p>
                    <table class="table">
                      <thead>
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">A</th>
                          <th scope="col">B</th>
                          <th scope="col">M</th>
                          <th scope="col">N</th>  
                        </tr>
                        </thead>
                      <tbody id="seqTable">
                      </tbody>
                    </table>
                    <button id="seqDownloadBtn" type="button" class="btn btn-primary">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download"
                        viewBox="0 0 16 16">
                        <path
                          d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5" />
                        <path
                          d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z" />
                      </svg>
                    </button>
                    <a id="seqDownload"></a> <!-- used to create automatic download of sequence -->                
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Acquisition settings
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                  data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <form>
                      <div class="form-group row">
                        <label for="injection_duration" class="col col-form-label">Injection duration [s]</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="injection_duration" value="0.2">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="nb_meas" class="col col-form-label">Nb Measurements</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="nb_meas" value="1">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="sequence_delay" class="col col-form-label">Sequence delay [s]</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="sequence_delay" value="100">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="nb_stack" class="col col-form-label">Nb stack</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="nb_stack" value="1">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="duty_cycle" class="col col-form-label">Duty cycle [0 -> 1]</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="duty_cycle" value="0.5">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="elec_spacing" class="col col-form-label">Electrode spacing [m]</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="elec_spacing" , value="1">
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingThree">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseThree" aria-expanded="false" aria-controls="headingThree">
                    Injection strategy
                  </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                  data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <p>The <code>safe</code> strategy will try inject the requested Vab voltage and decrease it if it goes over
                      the hardware limitations.</p>
                    <p>The <code>vmax</code> strategy will try to inject the maximum Vab voltage.</p>
                    <p>The <code>vmin</code> strategy will inject the Vab voltage that reach the Vmn requested.</p>
                    <p>The <code>fixed</code> strategy will inject the requested Vab voltage without checking for hardware limitations.</p>
                    <form>
                      <div class="form-group row">
                        <label for="strategy" class="col col-form-label">Strategy:</label>
                        <div class="col">
                          <select id="strategySelect" class="form-select">
                            <option value="safe">Safe</option>
                            <option value="vmin">Vmin</option>
                            <option value="vmax">Vmax</option>
                            <option value="fixed">Fixed</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="vab_req" class="col col-form-label">Vab requested [V]
                          (<code>vab_req</code>):</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="vab_req" value="5">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="vmn_req" class="col col-form-label">Vmn requested [V] (<code>vmn_req</code>):</label>
                        <div class="col">
                          <input type="number" class="form-control-number" id="vmn_req" value="20" disabled>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="saveConfigBtn" type="button" data-bs-dismiss="modal" class="btn btn-primary">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- Modal for data -->
      <div class="modal fade" id="rmModal" tabindex="-1" role="dialog" aria-labelledby="settingModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="settingModalLabel">Data download</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Downloading data can take up to several minutes as data is first zipped on the OhmPi. When it is ready, it will <b>automatically download</b> onto your device. By default all data are download (.csv and .zip with full-waveform data). It is also possible to choose a specific format for data export.</p>
              <div class="form-group row">
                <label for="ftypeSelect" class="col col-form-label">File format:</label>
                <div class="col">
                  <select id="ftypeSelect" class="form-select">
                    <option value="ohmpi">OhmPi (default)</option>
                    <option value="bert">bert/pygimli</option>
                    <option value="protocol">ResIPy/R2 (protocol.dat)</option>
                  </select>
                </div>
              </div>
              <hr>
              <button id="downloadBtn" type="button" class="btn btn-primary" data-bs-dismiss="modal">Download current acquisition</button>
              <hr>
              <p>Download data between these dates:</p>
              <form>
                <div class="form-group row">
                  <label for="startDate" class="col-sm-2 col-form-label">Start date</label>
                  <div class="col-sm-10">
                    <input id="startDate" class="form-control" type="date" />
                  </div>
                </div>
                <div class="form-group row">
                  <label for="endDate" class="col-sm-2 col-form-label">End data</label>
                  <div class="col-sm-10">
                    <input id="endDate" class="form-control" type="date" />
                  </div>
                </div>
              </form>
              <button id="downloadSelectBtn" type="button" class="btn btn-primary" data-bs-dismiss="modal">Download selected</button>
              <hr>
              <div class="alert alert-danger" role="alert">
                Remove all data of the current acquisition.
              </div>
              <button id="removeDataBtn" type="button" class="btn btn-danger" data-bs-dismiss="modal">Clear data</button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- modal for hardware error-->
      <!-- <div class="modal fade" id="hwError" tabindex="-1" role="dialog" aria-labelledby="hwErrorLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="hwErrorLabel">Hardware Error</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-danger" role="alert">
                An hardware error was encountered, the OhmPi cannot start.
                Power off the OhmPi, fix the error and power it on again.
              </div>
              Error log from SOH
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div> -->

      <footer>v0.4.0</footer>
    </div>

    <script type="text/javascript">
      //let serverUrl = 'http://10.3.141.1:8080'
      //let serverUrl = 'http://0.0.0.0:8080'
      //let serverUrl = 'http://localhost:8080'
      let serverUrl = 'http://' + window.location.host
      console.log('serverUrl =', serverUrl)
      let output = document.getElementById('output')
      let data = {} // hold data of all surveys
      let interv = null // hold interval for automatic data retrieval
      let quads = [] // available quadrupoles for time-serie figure
      let squads = [] // selected quadrupoles for time-serie figure
      let commands = {} // store commands and their id
      let callbacks = {} // store callback (might not be needed)
      let sequence = [] // uploaded or generated quadrupole sequence
      let invertedData = {
        'current': {
          /*
          rho: [[10, 10.625, 12.5, 15.625, 20],
                  [5.625, 6.25, 8.125, 11.25, 15.625],
                  [2.5, 3.125, 5., 8.125, 12.5],
                  [0.625, 1.25, 3.125, 6.25, 10.625],
                  [0, 0.625, 2.5, 5.625, 10]],
          x: [-9, -6, -5 , -3, -1],
          y: [0, 1, 4, 5, 7],
          */
          rho: [],
          x: [],
          y: []
        }
      } // store inverted data

      // possible attributes and their labels
      let key2lab = {
        'app': 'App. Res. [Ohm.m]',
        'r': 'Resistance [Ohm]',
        'i': 'Current [mA]',
        'v': 'Voltage [mV]',
        'dev': 'R std [%]',
      }

      // check for SOH log file to see if any hardware error
      var soherror = ''
      fetch("ohmpi/logs/soh.log")
        .then((res) => res.text())
        .then((text) => {
          soherror = text.split('***').at(-1)
          console.log('log=', soherror)
          soherror.split('\n').forEach(line => {
            console.log('line', line)
            if (line.toLowerCase().includes('not')) {
              document.getElementById('hwErrorAlert').setAttribute('style', 'display:block;')
              document.getElementById('hwErrorLog').innerText = line.replace('[31m','').replace('[0m', '')
            }
          })

          // if (soherror.toLowerCase().includes('not found')) {
          //   document.getElementById('hwErrorAlert').setAttribute('style', 'display:block;')
          //   document.getElementById('hwErrorLog').innerText = soherror
          // }
        })
        .catch((e) => console.error(e));
      // also monitor the current log maybe?

      var ohmpi_id = ''
      // TODO parse mqtt_user and password
      fetch('ohmpi/config.py')
        .then((res) => res.text())
        .then((text) => {
          ohmpi_id = text
          let lines = text.split('\n')
          for (line of lines) {
            if (line.split('=').at(0).includes('ohmpi_id')) {
              ohmpi_id = line.split("'").at(1)
              console.log(ohmpi_id)
              document.getElementById('mqttTopic').value = 'ohmpi_' + ohmpi_id
              break
            }
          }
        })
        .catch((e) => console.log('parse config.py error:', e))

      // variables with MQTT, can be updated via mqtt modal
      let topic = document.getElementById('mqttTopic').value
      let topic_ctrl = topic + '/ctrl'
      let topic_exec = topic + '/exec'
      let topic_data = topic + '/data'
      let topic_soh = topic + '/soh'
      let client = null  // mqtt client instance
      let clientId = generateUniqSerial()
      document.getElementById('mqttClientId').value = clientId
      let message = null
      let msg = ''
      let execlog = document.getElementById('execlog')
      let datalog = document.getElementById('datalog')
      let ctrllog = document.getElementById('ctrllog')
      let sohlog = document.getElementById('sohlog')

      // try connection directly
      document.getElementById('mqttHostname').value = location.hostname
      mqttConnect()

      // alternative to the above default
      function mqttConnect() {
        // get variables
        let hostname = document.getElementById('mqttHostname').value
        let port = parseInt(document.getElementById('mqttPort').value)
        let username = document.getElementById('mqttUser').value
        let password = document.getElementById('mqttPwd').value
        topic = document.getElementById('mqttTopic').value
        topic_ctrl = topic + '/ctrl'
        topic_exec = topic + '/exec'
        topic_data = topic + '/data'
        topic_soh = topic + '/soh'
      
        // create client
        client = new Paho.MQTT.Client(hostname, port, clientId)
        client.onConnectionLost = onConnectionLost
        client.onMessageArrived = onMessageArrived
        client.connect({userName: username, password: password, onSuccess: onConnect })
      }
      document.getElementById('mqttConnectBtn').addEventListener('click', mqttConnect)

      function onConnect() {
        console.log("onConnect")
        client.subscribe(topic_data)
        client.subscribe(topic_exec)
        client.subscribe(topic_soh)
        client.subscribe(topic_ctrl)

        // send welcome message
        // message = new Paho.MQTT.Message("Hello from index.html")
        // message.destinationName = topic_soh
        // client.send(message)
        document.getElementById('connection').innerText = 'Connected'
      }

      function onConnectionLost(responseObject) {
        document.getElementById('connection').innerText = 'Connecting...'
        if (responseObject.errorCode !== 0)
          console.log("onConnectionLost:" + responseObject.errorMessage)
        console.log("trying to reconnect...")
        let hostname = document.getElementById('mqttHostname').value
        let port = parseInt(document.getElementById('mqttPort').value)
        let username = document.getElementById('mqttUser').value
        let password = document.getElementById('mqttPwd').value
        client.connect({ userName: username, password: password, onSuccess: onConnect })
      }

      function onMessageArrived(message) {
        try {
          let payload = message.payloadString
          if (message.topic == topic_data) {
            // process data
            msg = payload // for accessing the variable from the console

            // put in the log
            datalog.value = datalog.value.split('\n').slice(0, 100).join('\n') + '\n' + payload
            datalog.scrollTop = datalog.scrollHeight
            
            // replace NaN values by null to make them acceptable for json parser
            payload = payload.replace(/\bNaN\b/g, "null");
            payload = payload.replace(/\bnan\b/g, "null");

            // parse to json
            let ddic = JSON.parse(payload.split('INFO:')[1].replace(/'/g, '"'))
            if (! ('status' in ddic)) {
              ddic['status'] = 'running...'
            }

            // RS check data
            if ('rsdata' in ddic) {
                // append data to the latest serie
                rsdata[rsdata.length - 1]['x'].push(ddic['rsdata']['A']), //, + '-' + ddic['rsdata']['B'],
                rsdata[rsdata.length - 1]['y'].push(ddic['rsdata']['rs']),
                Plotly.redraw('rs')

            } else if ('download' in ddic) {
              let dwl = document.getElementById('download')
              dwl.setAttribute('href', serverUrl + '/data.zip')
              dwl.setAttribute('download', 'data.zip')
              dwl.click()
            } else if ('inversion' in ddic) {
              document.getElementById('invOutput').innerText = ddic['inversion']
              if (ddic['inversion'].includes('SUCCESS')) {
                invertedData = {
                  ...invertedData,
                  ...ddic['invertedData']
                }
                showInvFunc()
              }
              var btn = document.getElementById('invertBtn')
              btn.innerText = 'Run inversion'
              btn.className = 'btn btn-info'  
            } else { // data
              processMessage(ddic)
            }

            if ('status' in ddic) {
              document.getElementById('output').value = ddic['status']
              if (ddic['status'].includes('full-waveform')) {
                document.getElementById('getDataFWBtn').innerText = 'Get full-waveform data'
              }
            }

            // usually these don't have a cmd_id so we are not sure when

          } else if (message.topic == topic_exec) {
            // display it in the log
            execlog.value = execlog.value.split('\n').slice(0, 100).join('\n') + '\n' + payload
            execlog.scrollTop = execlog.scrollHeight
          } else if (message.topic == topic_soh) {
            sohlog.value = sohlog.value.split('\n').slice(0, 100).join('\n') + '\n' + payload
            sohlog.scrollTop = sohlog.scrollHeight
          } else if (message.topic == topic_ctrl) {
            ctrllog.value = ctrllog.value.split('\n').slice(0, 100).join('\n') + '\n' + payload
            ctrllog.scrollTop = ctrllog.scrollHeight
          }


          // let response = JSON.parse(message.payloadString)
          // console.log('response=', response)
          // // check ID of message against our dictionnary of callback
          // let cmd_id = response['cmd_id']
          // if (callbacks.hasOwnProperty(cmd_id)) {
          //     console.log('++ execute callback')
          //     callbacks[cmd_id](response['content']) // execute callback
          // }
        } catch (e) {
          console.log(e, 'for message:', message.payloadString)
        }
        // client.disconnect()
      }

      // useful functions
      function generateUniqSerial() {
        return 'xxxx-xxxx-xxx-xxxx'.replace(/[x]/g, (c) => {
          const r = Math.floor(Math.random() * 16);
          return r.toString(16);
        });
      }

      // sending commands to the OhmPi
      function sendCommand(query, callback=null) {
        // dic in the form: {'cmd': X, ...} as JSON
        if (callback == null) {
          function callback(x) {
            console.log('default callback:', x)
          }
        }

        /*
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (xhr.status == 200) {
                    callback(JSON.parse(xhr.response))
                }
            }
        }
        xhr.open('POST', serverUrl)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(query)
        */

        // generate a unique command id to be associated with the commands
        let uuid = generateUniqSerial()
        commands[uuid] = query
        callbacks[uuid] = callback // store the callback to be processed later when message arrives
        let payload = '{"cmd_id": "' + uuid + '",' + query.slice(1)
        console.log('sendCommand()', payload)
        message = new Paho.MQTT.Message(payload)
        message.destinationName = topic_ctrl // control subtopic on broker
        client.send(message)
      }

      // run button
      function runBtnFunc() {
        sendCommand('{"cmd": "run_multiple_sequences"}', function (x) {
          console.log(x['status'])
          if (x['status'] == 'running') {
            output.innerHTML = 'Status: measuring...'
          }
        })
      }
      let runBtn = document.getElementById('runBtn')
      runBtn.addEventListener('click', runBtnFunc)

      // interrupt button
      function stopBtnFunc() {
        output.innerHTML = 'Status: interrupting...'
        sendCommand('{"cmd": "interrupt"}', function (x) {
          output.innerHTML = 'Status: ' + x['status']
          clearInterval(interv)
          getData()
        })
      }
      let stopBtn = document.getElementById('stopBtn')
      stopBtn.addEventListener('click', stopBtnFunc)

      // get sequence from file
      function readSequence(callback) {
        // deal with the potential file containing the sequence
        // https://stackoverflow.com/questions/19038919/is-it-possible-to-upload-a-text-file-to-input-in-html-js
        if (!window.FileReader) {
          alert('Your browser is not supported');
          return false;
        }
        let input = document.getElementById('sequence')
        if (input.files.length) {
          const reader = new FileReader()
          reader.readAsText(input.files[0])
          reader.addEventListener('load', () => {
            // parse the file and make it a list of list of int
            var a = reader.result.split(/\r?\n|\r|\n/g)
            var seq = new Array()
            var eof = false
            for (var i = 0; i < a.length; i++) {
              b = a[i].split(' ')
              var arr = new Array(4)
              for (var j = 0; j < b.length; j++) {
                val = parseInt(b[j])
                if (isNaN(val) == true) {
                  eof = true
                  break
                }
                arr[j] = val
              }
              if (eof == true) {
                break
              }
              seq.push(arr)
            }
            sequence = seq
            callback(seq)
          })
        } else {
          console.log('no file provided')
          seq = ''
          callback(seq)
        }
      }

      let seqTypeSelect = document.getElementById('seqTypeSelect')
      seqTypeSelect.addEventListener('change', function() {
        if (seqTypeSelect.value == 'gradient') {
          document.getElementById('seqParamS').removeAttribute('disabled')
        } else {
          document.getElementById('seqParamS').setAttribute('disabled', '')
        }
        if (seqTypeSelect.value == 'wenner') {
          document.getElementById('seqParamN').setAttribute('disabled', '')
        } else {
          document.getElementById('seqParamN').removeAttribute('disabled')
        }
      })
      function seqGenerateBtnFunc() {
        // TODO call api ohmpi, read back output
        // create small simple custom functions
        let seqType = seqTypeSelect.value
        let seqNelec = document.getElementById('seqNelec').value
        let seqParamA = document.getElementById('seqParamA').value
        let seqParamN = document.getElementById('seqParamN').value
        let seqParamS = document.getElementById('seqParamS').value
        let gseq = []
        if (seqType == 'wenner') {
          for (let pa = 1; pa <= seqParamA; pa++) {
            for (let a = 1; a <= seqNelec; a++) {
              let m = a + pa
              let n = m + pa
              let b = n + pa
              if ((a <= seqNelec) & (b <= seqNelec) & (m <= seqNelec) & (n <= seqNelec)) {
                gseq.push([a, b, m, n])
              }
            }
          }
        } else if (seqType == 'dpdp') {
          for (let pa = 1; pa <= seqParamA; pa++) {
            for (let a = 1; a <= seqNelec; a++) {
              let b = a + pa
              for (let m = b + pa; m <= b + pa * seqParamN; m += pa) {
                let n = m + pa
                if ((a <= seqNelec) & (b <= seqNelec) & (m <= seqNelec) & (n <= seqNelec)) {
                  gseq.push([a, b, m, n])
                }
              }
            }
          }
        } else if (seqType == 'schlum') {
          for (let a = 1; a <= seqNelec; a++) {
            for (let nn = 1; nn <= seqParamN; nn++) {
              for (let pa = 1; pa <= seqParamA; pa++) {
                if (nn >= pa-1) {
                  let m = a + nn
                  let n = m + pa
                  let b = n + nn
                  if ((a <= seqNelec) & (b <= seqNelec) & (m <= seqNelec) & (n <= seqNelec)) {
                    gseq.push([a, b, m, n])
                  }
                }
              }
            }
          }
        } else if (seqType == 'gradient') {
          for (let a = 1; a <= seqNelec; a++) {
            for (let nn = 1; nn <= seqParamN; nn++) {
              for (let s = 1; s <= seqParamS; s++) {
                for (let pa = 1; pa <= seqParamA; pa++) {
                  if (nn >= pa-1) {
                    let m = a + pa * nn
                    let n = m + pa
                    let b = a + (s + 2) * pa
                    if ((a <= seqNelec) & (b <= seqNelec) & (m <= seqNelec) & (n <= seqNelec) & (m < b) & (n < b)) {
                      gseq.push([a, b, m, n])
                    }
                  }
                }
              }
            }
          }
        }
        console.log(gseq)
        sequence = gseq
        buildSeqTable(gseq)
      }
      document.getElementById('seqGenerateBtn').addEventListener('click', seqGenerateBtnFunc)

      function buildSeqTable(seq) {
        let tbody = document.getElementById('seqTable')
        tbody.innerHTML = '' // remove all content
        let count = 1
        for (let i = 0; i < seq.length; i++) {
          var tr = document.createElement('tr')
          var td2 = document.createElement('td')
          td2.innerText = count + i
          td2.setAttribute('scope', 'row')
          tr.appendChild(td2)
          for (let j = 0; j < seq[i].length; j++) {
            var td = document.createElement('td')
            td.innerText = seq[i][j]
            tr.appendChild(td)
          }
          tbody.appendChild(tr)
        }
      }

      // display sequence
      function viewSeqBtnFunc() {
        readSequence(buildSeqTable)
      }
      // document.getElementById('viewSeqBtn').addEventListener('click', viewSeqBtnFunc)
      document.getElementById('sequence').addEventListener('change', viewSeqBtnFunc)

      // download sequence
      function seqDownloadBtnFunc() {
        let content = 'a,b,m,n\n'
        for (let i = 0; i < sequence.length; i++) {
          content = content + sequence[i].join(',') + '\n'
        }
        let dwl = document.getElementById('seqDownload')
        dwl.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content))
        dwl.setAttribute('download', 'sequence.csv')
        dwl.click()
      }
      document.getElementById('seqDownloadBtn').addEventListener('click', seqDownloadBtnFunc)

      // strategies
      let strategySelect = document.getElementById('strategySelect')
      function strategySelectFunc() {
        if ((strategySelect.value == 'safe') || (strategySelect.value == 'fixed')) {
          document.getElementById('vab_req').removeAttribute('disabled')
          document.getElementById('vmn_req').setAttribute('disabled', '')
        } else if (strategySelect.value == 'vmax') {
          document.getElementById('vab_req').setAttribute('disabled', '')
          document.getElementById('vmn_req').setAttribute('disabled', '')
        } else if (strategySelect.value == 'vmin') {
          document.getElementById('vab_req').setAttribute('disabled', '')
          document.getElementById('vmn_req').removeAttribute('disabled')
        }
      }
      strategySelect.addEventListener('change', strategySelectFunc)

      // set configuration
      function saveConfigBtnFunc() {
        // collect values from modal
        let formVals = {
          //'nb_electrodes': parseInt(document.getElementById('nb_electrodes').value),
          'injection_duration': parseFloat(document.getElementById('injection_duration').value),
          'nb_meas': parseInt(document.getElementById('nb_meas').value),
          'sequence_delay': parseFloat(document.getElementById('sequence_delay').value),
          'n_stacks': parseInt(document.getElementById('nb_stack').value),
          'duty_cycle': parseFloat(document.getElementById('duty_cycle').value),
          'strategy': strategySelect.value,
        }

        // add strategies
        if ((strategySelect.value == 'safe') | (strategySelect.value == 'fixed')) {
          formVals['vab_req'] = parseFloat(document.getElementById('vab_req').value)
        } else if (strategySelect.value == 'vmin') {
          formVals['vmn_req'] = parseFloat(document.getElementById('vmn_req').value)
        }

        // check if we have a sequence or not
        if (sequence.length > 0) {
          formVals['sequence'] = sequence
        } 
        console.log(formVals)

        // send settings to the controller
        sendCommand(JSON.stringify({
          'cmd': 'update_settings',
          'kwargs': {
            'settings': formVals
          }
        }), function (x) {
          console.log('update_settings', x)
        })
      }
      let saveConfigBtn = document.getElementById('saveConfigBtn')
      saveConfigBtn.addEventListener('click', saveConfigBtnFunc)

      // make pseudo plot
      var trace = {
        x: [],
        y: [],
        mode: 'markers',
        marker: {
          size: 40,
          color: [],
          colorbar: {
            //title: 'Apparent resistivity [Ohm.m]',
            titleside: 'right',
            cmin: 0,
            cmax: 100,
          },
          colorscale: 'Electric'
        }
      }
      let layout = {
        title: 'Pseudo-section',
        yaxis: {
          title: 'Pseudo-depth',
        },
        xaxis: {
          title: 'X'
        }

      }
      Plotly.newPlot('gd', [trace], layout, { responsive: true })

      // make time-serie plot
      let tdata = []
      let layout2 = {
        title: 'Time-serie',
        yaxis: {
          title: 'App. res. [Ohm.m]'
        },
        xaxis: {
          title: 'Sampling time'
        }
      }
      Plotly.newPlot('ts', tdata, layout2, { responsive: true })

      // update traces
      function updateTraces() {
        let surveyNames = Object.keys(data).sort()
        let attr = document.getElementById('attrSelectTrace').value

        // transform all surveyNames to datetime
        let xt = []
          for (surveyName of surveyNames) {
            let a = surveyName.split('_').slice(-1)[0]
            xt.push(a.slice(0, 4) + '-'
              + a.slice(4, 6) + '-'
              + a.slice(6, 8) + ' '
              + a.slice(9, 11) + ':'
              + a.slice(11, 13) + ':'
              + a.slice(13, 15))
          }

          // create one new trace per selected quadrupole
          for (let k = 0; k < squads.length; k++) {
            squad = squads[k]
            let x = []
            let y = []
            for (let i = 0; i < surveyNames.length; i++) {
              df = data[surveyNames[i]]
              for (let j = 0; j < df['a'].length; j++) {
                if (df['a'][j] == squad[0]
                  && df['b'][j] == squad[1]
                  && df['m'][j] == squad[2]
                  && df['n'][j] == squad[3]) {
                  y.push(df[attr][j])
                  x.push(xt[i])
                  break
                }
              }
            }

            // update trace dictionnary
            tdata[k]['x'] = x
            tdata[k]['y'] = y
            layout2['yaxis']['title'] = key2lab[attr]
          }
        Plotly.redraw('ts')
      }
      document.getElementById('attrSelectTrace').addEventListener('change',
        updateTraces
      )

      // add trace to time-serie plot
      function addTraceBtnFunc() {
        let val = document.getElementById('quadSelect').value
        squads.push(val.split(', '))
        tdata.push({
          x: [],
          y: [],
          name: val,
          type: 'scatter'
        })
        Plotly.newPlot('ts', tdata, layout2, { responsive: true })
        updateTraces() // populating the traces
      }
      let addTraceBtn = document.getElementById('addTraceBtn')
      addTraceBtn.addEventListener('click', addTraceBtnFunc)

      // remove all traces from time-serie plot
      function removeTracesBtnFunc() {
        squads = []
        tdata = []
        Plotly.newPlot('ts', tdata, layout2, { responsive: true })
      }
      let removeTracesBtn = document.getElementById('removeTracesBtn')
      removeTracesBtn.addEventListener('click', removeTracesBtnFunc)

      // computeApp assuming a flat 2D surface with elec at the surface
      function computeApp(surveyName) {
        let elec_spacing = parseFloat(document.getElementById('elec_spacing').value)
        let df = data[surveyName]
        if (df != undefined) {
          let a = df['a']
          let b = df['b']
          let m = df['m']
          let n = df['n']
          // compute app res (assuming flat, line survey)
          let xpos = []
          let ypos = []
          let values = []
          for (let i = 0; i < a.length; i++) {
            let emin = Math.min(...[a[i], b[i], m[i], n[i]]) * elec_spacing
            let emax = Math.max(...[a[i], b[i], m[i], n[i]]) * elec_spacing
            let dist = Math.abs(emax - emin)
            xpos.push(emin + dist / 2)
            ypos.push(- Math.sqrt(2) / 2 * dist)
            let am = Math.abs(a[i] - m[i]) * elec_spacing
            let bm = Math.abs(b[i] - m[i]) * elec_spacing
            let an = Math.abs(a[i] - n[i]) * elec_spacing
            let bn = Math.abs(b[i] - n[i]) * elec_spacing
            let K = (2 * Math.PI) / ((1 / am) - (1 / an) - (1 / an) + (1 / bn))
            values.push(Math.round(df['r'][i] * K))
          data[surveyName]['app'] = values
          }
        }
      }

      // callback function to draw the plot
      function surveySelectFunc() {
        let elec_spacing = parseFloat(document.getElementById('elec_spacing').value)
        let surveyName = document.getElementById('surveySelect').value
        let attr = document.getElementById('attrSelect').value
        let ilog = document.getElementById('logCheck').checked
        let df = data[surveyName]
        if (df != undefined) {
          let a = df['a']
          let b = df['b']
          let m = df['m']
          let n = df['n']
          // compute pseudo-depth (assuming no topo)
          let xpos = []
          let ypos = []
          let values = []
          for (let i = 0; i < a.length; i++) {
            let emin = Math.min(...[a[i], b[i], m[i], n[i]]) * elec_spacing
            let emax = Math.max(...[a[i], b[i], m[i], n[i]]) * elec_spacing
            let dist = Math.abs(emax - emin)
            xpos.push(emin + dist / 2)
            yy = - Math.sqrt(2) / 2 * dist
            ypos.push(Math.round(yy*1000)/1000)
            values = [...df[attr]]  // use [...array] to make a copy
          }
          
          // apply log
          if (ilog) {
            for (let j = 0; j < values.length; j++) {
              values[j] = Math.log10(values[j])
            }
          }

          // update the trace and redraw the figure
          trace['x'] = xpos
          trace['y'] = ypos
          trace['marker']['color'] = values
          trace['marker']['cmax'] = document.getElementById('cmax').value
          trace['marker']['cmin'] = document.getElementById('cmin').value
          trace['marker']['colorscale'] = document.getElementById('cmap').value
          //trace['marker']['colorbar']['title'] = key2lab[attr]
          Plotly.redraw('gd')
        }
      }
      let surveySelect = document.getElementById('surveySelect')
      document.getElementById('attrSelect').addEventListener('change', surveySelectFunc)
      document.getElementById('cmap').addEventListener('change', surveySelectFunc)
      document.getElementById('logCheck').addEventListener('change', surveySelectFunc)
      document.getElementById('cmin').addEventListener('change', surveySelectFunc)
      document.getElementById('cmax').addEventListener('change', surveySelectFunc)
      
      
      // raw table
      let surveyTableSelect = document.getElementById('surveyTableSelect')
      function surveyTableSelectFunc() {
        let surveyName = surveyTableSelect.value
        if (surveyName in data) {
          let df = data[surveyName]
          let tbody = document.getElementById('rawTable')
          tbody.innerHTML = '' // remove all content
          let count = 1
          for (let i = 0; i < df['a'].length; i++) {
            var tr = document.createElement('tr')
            var td2 = document.createElement('td')
            td2.innerText = count + i
            td2.setAttribute('scope', 'row')
            tr.appendChild(td2)
            for (col of ['a', 'b', 'm', 'n', 'v', 'i', 'r', 'dev', 'app']) {
              var td = document.createElement('td')
              td.innerText = df[col][i]
              tr.appendChild(td)
            }
            tbody.appendChild(tr)
          }
        }
      }
      surveyTableSelect.addEventListener('change', surveyTableSelectFunc)

      // bar chart for contact resistance
      let rsdata = []
      let rslayout = {
        barmode: 'group',
        title: 'Contact resistances',
        yaxis: {
          title: 'Resistance [kOhm]'
        },
        xaxis: {
          title: 'Consecutive electrodes'
        }
      }
      Plotly.newPlot('rs', rsdata, rslayout, { responsive: true })

      // run RS check
      function rsBtnFunc() {
        // add a new serie
        rsdata.push({
            x: [],
            y: [],
            name: 'RS' + rsdata.length,
            type: 'bar'
          })
        sendCommand('{"cmd": "rs_check"}')
      }
      let rsBtn = document.getElementById('rsBtn')
      rsBtn.addEventListener('click', rsBtnFunc)

      // clear RS graph
      function rsClearBtnFunc() {
        rsdata = [{
          'x': [],
          'y': [],
          name: 'RS',
          type: 'bar',
        }]
        Plotly.newPlot('rs', rsdata, rslayout, { responsive: true })
      }
      let rsClearBtn = document.getElementById('rsClearBtn')
      rsClearBtn.addEventListener('click', rsClearBtnFunc)

      // full-waveform figure
      let fwdata = [{
        'x': [1, 2, 3, 4],
        'y': [1, 4, 9, 4],
        name: 'iab',
        yaxis: 'y2',
        type: 'scatter',
      }, {
        'x': [1, 2, 3, 5],
        'y': [1, 1, 0, 0],
        name: 'vmn',
        yaxis: 'y',
        type: 'scatter',
      }
      ]
      let fwlayout = {
        title: 'Full-waveform',
        yaxis2: {
          title: 'Current [mA]',
          domain: [0.55, 1]
        },
        yaxis: {
          title: 'Voltage [mV]',
          domain: [0, 0.45]
        },
        xaxis: {
          title: 'Time [s]'
        },
      }
      Plotly.newPlot('fw', fwdata, fwlayout, {responsive: true })
      // https://plotly.com/javascript/subplots/#subplots-with-shared-axes

      let surveyFWSelect = document.getElementById('surveyFWSelect')
      let quadFWSelect = document.getElementById('quadFWSelect')
      let fwValues = document.getElementById('fwValues')
      function updateFW() {
        let surveyName = surveyFWSelect.value
        let key = quadFWSelect.value
        fwdata[0]['x'] = []
        fwdata[0]['y'] = []
        fwdata[1]['x'] = []
        fwdata[1]['y'] = []
        if ('fw' in data[surveyName]) {
          if (key in data[surveyName]['fw']) {
            let dic = data[surveyName]['fw'][key]
            fwdata[0]['x'] = dic['t']
            fwdata[0]['y'] = dic['i']
            fwdata[1]['x'] = dic['t']
            fwdata[1]['y'] = dic['v']
          }
        }
        Plotly.redraw('fw')

        // add the average values
        let q = key.split(',')
        let a = parseInt(q[0])
        let b = parseInt(q[1])
        let m = parseInt(q[2])
        let n = parseInt(q[3])
        let df = data[surveyName]
        let found = false
        for (let i = 0; i < df['a'].length; i++) {
          if ((a == df['a'][i]) & (b == df['b'][i]) & (m == df['m'][i]) & (n == df['n'][i])) {
            let iab = df['i'][i]
            let vmn = df['v'][i]
            let r = df['r'][i]
            fwValues.innerText = ' Iab: ' + iab + ' mA     Vmn: ' + vmn + ' mV    R: ' + r + ' Ohm'
            found = true
          }
        }
        if (found == false) {
          fwValues.innerText = ''
        }
      }
      surveyFWSelect.addEventListener('change', updateFW)
      quadFWSelect.addEventListener('change', updateFW)

      // getData
      function getData() {
        output.innerHTML =  'Status: getting data...'
        sendCommand(JSON.stringify({
          'cmd': 'get_data',
          'kwargs': {
            'survey_names': Object.keys(data).slice(0, -1),
          // last survey is often partial so we download it again
            'full': false,
          }
        }), console.log('processData(ddic)')
        )
      }

      function getDataFWBtnFunc() {
        // disable show-live data checkbox
        clearInterval(interv)
        document.getElementById('dataRetrievalCheck').checked = false

        // update status
        output.innerHTML =  'Status: getting full-waveform data...'
        document.getElementById('getDataFWBtn').innerText = 'Getting FW data...'
        sendCommand(JSON.stringify({
          'cmd': 'get_data',
          'kwargs': {
            'survey_names': [], // download them all again with FW data
          // last survey is often partial so we download it again
            'full': true,
          }
        }), console.log('processData(ddic)')
        )
      }
      document.getElementById('getDataFWBtn').addEventListener('click', getDataFWBtnFunc)

      // processMessage
      function processMessage(ddic) {
        //if (('status' in ddic) | ('data' in ddic)) {
        if (ddic.constructor == Object) {  // it's a dictionnary
          // acquisition related
          processData(ddic)
        } else {
          console.log('should not called .................')
        }
      }

      // processData
      function processData(ddic) {
        // update status
        output.innerHTML = 'Status: ' + ddic['status']
        if (ddic['status'].includes('full-waveform')) {
          document.getElementById('getDataFWBtn').innerText = 'Get full-waveform data'
        }

        // update data dic with new data
        data = { // destructuring assignment (magic! :o)
          ...data,
          ...ddic['data'] // value from second dic are preferred
        }

        // compute apparent resistivities for new survey
        for (key in ddic['data']) {
          computeApp(key)
        }

        // dropdown with number of surveys and +++
        let surveyNames = Object.keys(data).sort()

        // remove listener, replace choice and add listener again
        surveySelect.removeEventListener('change', surveySelectFunc)
        surveySelect.innerHTML = ''  // clearing all child nodes
        for (let surveyName of surveyNames) {
          let option = document.createElement('option')
          option.innerText = surveyName
          option.value = surveyName
          surveySelect.appendChild(option)
        }
        surveySelect.addEventListener('change', surveySelectFunc)

        // plot last one by default
        surveySelect.value = surveyNames[surveyNames.length - 1]

        // call the function directly
        // (as programatically changing the value does not trigger the event)
        surveySelectFunc()

        // update list of survey for table
        surveyTableSelect.removeEventListener('change', surveyTableSelectFunc)
        surveyTableSelect.innerHTML = ''
        for (let surveyName of surveyNames) {
          let option = document.createElement('option')
          option.innerText = surveyName
          option.value = surveyName
          surveyTableSelect.appendChild(option)
        }
        surveyTableSelect.addEventListener('change', surveyTableSelectFunc)
        surveyTableSelect.value = surveyNames[surveyNames.length - 1]
        surveyTableSelectFunc()

        // update list of survey for full-waveform
        surveyFWSelect.removeEventListener('change', updateFW)
        surveyFWSelect.innerHTML = ''  // clearing all child nodes
        for (let surveyName of surveyNames) {
          let option = document.createElement('option')
          option.innerText = surveyName
          option.value = surveyName
          surveyFWSelect.appendChild(option)
        }
        surveyFWSelect.addEventListener('change', updateFW)
        surveyFWSelect.value = surveyNames[surveyNames.length - 1]

        // update list of survey for inversion
        surveySelectInv.removeEventListener('change', showInvFunc)
        surveySelectInv.innerHTML = ''  // clearing all child nodes
        for (let surveyName of surveyNames) {
          let option = document.createElement('option')
          option.innerText = surveyName
          option.value = surveyName
          surveySelectInv.appendChild(option)
        }
        surveySelectInv.addEventListener('change', showInvFunc)
        surveySelectInv.value = surveyNames[surveyNames.length - 1]

        // update list of quadrupoles if any
        if (surveyNames.length > 0) {
          // find longest survey
          let df = data[surveyNames[0]]
          for (let i = 0; i < surveyNames.length; i++) {
            //console.log(i, df['a'].length, data[surveyNames[i]]['a'].length)
            if (data[surveyNames[i]]['a'].length > df['a'].length) {
              df = data[surveyNames[i]]
            }
          }
          //console.log('======', df['a'].length)
          if (df['a'].length > quads.length) {
            let quadSelect = document.getElementById('quadSelect')
            quadSelect.innerHTML = ''
            quadFWSelect.removeEventListener('change', updateFW)
            quadFWSelect.innerHTML = ''
            for (let i = 0; i < df['a'].length; i++) {
                quad = [df['a'][i], df['b'][i], df['m'][i], df['n'][i]]
                quads.push(quad)
                let option = document.createElement('option')
                option.value = quad.join(', ')
                option.innerText = quad.join(', ')
                quadSelect.appendChild(option)
                let option2 = document.createElement('option')
                option2.value = quad.join(',')  // no space to save bandwidth
                option2.innerText = quad.join(', ')
                quadFWSelect.appendChild(option2)
            }
          }
          quadFWSelect.addEventListener('change', updateFW)
          updateFW()
          //console.log('quads=', quads)
        }

        // update time-serie figure
        if (squads.length > 0) {
          updateTraces()
        }
      }

      let getDataBtn = document.getElementById('getDataBtn')
      getDataBtn.addEventListener('click', getData)

      // plot inverted data
      function showInvFunc() {
        let sname = document.getElementById('surveySelectInv').value
        let cmin = parseFloat(document.getElementById('cminInv').value)
        let cmax = parseFloat(document.getElementById('cmaxInv').value)
        let logInvCheck = document.getElementById('logInvCheck').checked
        let autocontour = false
        if (isNaN(cmin) | isNaN(cmax)) {
          autocontour = true
        }
        
        // check if survey was already inverted
        let values = []
        let xx = []
        let zz = []
        let title = ''
        if (!(sname in invertedData)) {
          console.log('survey not yet inverted')
        } else {
           // convert rho to log10(rho)
          xx = invertedData[sname]['x']
          zz = invertedData[sname]['z']  
          if (logInvCheck) {
              title = 'Resistivity (log10) [Ohm.m]'
              for (let i = 0; i < invertedData[sname]['rho'].length; i++) {
                  let row = invertedData[sname]['rho'][i]
                  var arr = []
                  for (let j = 0; j < row.length; j++) {
                      arr.push(Math.log10(row[j]))
                  }
                  values.push(arr)
              }
          }
          else {
              title = 'Resistivity [Ohm.m]'
              values = invertedData[sname]['rho']
          }
        }

       
        var invData = [{
          z: values,
          x: xx,
          y: zz,
          type: 'contour',
          colorscale: document.getElementById('cmapInv').value,
          autocontour: autocontour,
          contours: {
            start: cmin,
            end: cmax,
            size: 10,
          },
          colorbar: {
            title: title,
            titleside: 'right',
            titlefont: {
              size: 14,
              family: 'Arial, sans-serif'
            }
          }
        }]

        var invLayout = {
          title: 'Inverted section',
          yaxis: {
            title: 'Z [m]',
          },
          xaxis: {
            title: 'X [m]'
          },
        }

        Plotly.newPlot('inv', invData, invLayout, { responsive: true })
        var btn = document.getElementById('invertBtn')
        btn.innerText = 'Run inversion'
        btn.className = 'btn btn-info'

      }
      showInvFunc()
      document.getElementById('surveySelectInv').addEventListener('change', showInvFunc)

      // add listener for checkboxes or others
      document.getElementById('cmaxInv').addEventListener('change', showInvFunc)
      document.getElementById('cminInv').addEventListener('change', showInvFunc)
      document.getElementById('cmapInv').addEventListener('change', showInvFunc)
      document.getElementById('logInvCheck').addEventListener('change', showInvFunc)

      // invert data
      function invertBtnFunc() {
        document.getElementById('invOutput').innerText = 'Inverting...'
        let survey_name = document.getElementById('surveySelectInv').value
        var btn = document.getElementById('invertBtn')
        btn.innerText = 'Inverting...'
        btn.className = 'btn btn-warning'
        var elec_spacing = parseFloat(document.getElementById('elec_spacing').value)
        if (isNaN(elec_spacing)) {
          elec_spacing = 1
        }
        sendCommand(JSON.stringify({
          'cmd': 'run_inversion',
          'kwargs': {
            'survey_names': [survey_name + '.csv'],
            'elec_spacing': elec_spacing,
          }
        }), function (x) {
          console.log('inversion results', x)
        })
      }
      let invertBtn = document.getElementById('invertBtn')
      invertBtn.addEventListener('click', invertBtnFunc)

      // checkbox interaction for data download
      function dataRetrievalCheckFunc(x) {
        if (x['target'].checked == true) {
          interv = setInterval(getData, 1000) // every 1s
        } else {
          clearInterval(interv)
        }
      }
      let dataRetrievalCheck = document.getElementById('dataRetrievalCheck')
      dataRetrievalCheck.addEventListener('change', dataRetrievalCheckFunc)

      // remove data
      function removeDataBtnFunc() {
        sendCommand('{"cmd": "remove_data"}', function (x) {
          data = {}
          output.innerHTML = 'Status: ' + x['status'] + ' (all data cleared)'
          console.log('all data removed')
        })
        data = {}
        quads = []
        getData()
        document.getElementById('quadSelect').innerHTML = ''
      }
      let removeDataBtn = document.getElementById('removeDataBtn')
      removeDataBtn.addEventListener('click', removeDataBtnFunc)

      // shutdown Pi
      function shutdownBtnFunc() {

        sendCommand('{"cmd": "shutdown"}', function (x) {
          console.log('shuting down...')
        })
      }
      let shutdownBtn = document.getElementById('shutdownBtn')
      shutdownBtn.addEventListener('click', shutdownBtnFunc)

      // restart Pi
      function restartBtnFunc() {
        sendCommand('{"cmd": "restart"}', function (x) {
          console.log('rebooting...')
        })
      }
      let restartBtn = document.getElementById('restartBtn')
      restartBtn.addEventListener('click', restartBtnFunc)

      // set time
      function setTimeBtnFunc() {
        d = new Date()
        sendCommand('{"cmd": "set_time", "kwargs": {"date": "' + d.toISOString() + '"}}',
          function (x) {
            console.log('time set')
          })
      }
      let setTimeBtn = document.getElementById('setTimeBtn')
      setTimeBtn.addEventListener('click', setTimeBtnFunc)

      // download data
      function downloadBtnFunc() {  // current acquisition
        let ftype = document.getElementById('ftypeSelect').value
        let elec_spacing = parseFloat(document.getElementById('elec_spacing').value)
        sendCommand('{"cmd": "download_data", "kwargs": {"ftype": "' + ftype + '", "elec_spacing": ' + String(elec_spacing) + '}}', function (x) {
            console.log(x)
          })
        }
      let downloadBtn = document.getElementById('downloadBtn')
      downloadBtn.addEventListener('click', downloadBtnFunc)

      function downloadSelectBtnFunc() { // between two dates
        let start_date = document.getElementById('startDate').value
        let end_date = document.getElementById('endDate').value
        let ftype = document.getElementById('ftypeSelect').value
        let elec_spacing = parseFloat(document.getElementById('elec_spacing').value)
        if ((start_date != '') & (end_date != '')) {
          sendCommand('{"cmd": "download_data", "kwargs": {"start_date": "' +
            start_date  + '", "end_date": "' + end_date + '", "ftype": "' +
            ftype + '", "elec_spacing": ' + String(elec_spacing) + '}}', function (x) {
            console.log(x)
          })
        }
      }
      let downloadSelectBtn = document.getElementById('downloadSelectBtn')
      downloadSelectBtn.addEventListener('click', downloadSelectBtnFunc)
      document.getElementById('endDate').valueAsDate = new Date();


      // testing
      var ddic2 = {
        'status': 'test_data',
        'data': {
          '20240405_203403': {
            'a': [1, 2, 3, 4, 5],
            'b': [4, 5, 6, 7, 8],
            'm': [2, 3, 4, 5, 6],
            'n': [3, 4, 5, 6, 7],
            'r': [3.2, 4.3, 2.1, 3.2, -0.5],
            'i': [12.3, 4, 2.3, 10.3, 13.2],
            'v': [1230, 300, 400, 2313, 3400],
            'dev': [0.01, 0.03, 0.03, 0.1, 0.2],
            'fw': {
              '1,4,2,3': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,2,0,0,2,2,0,0],
                'v': [0,30,30,0,0,-27,-27,0,0]
              },
              '2,5,3,4': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,4,4,0,0,4,4,0,0],
                'v': [0,40,40,0,0,-67,-67,0,0]
              },
              '3,6,4,5': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,2,0,0,2,3,0,0],
                'v': [0,60,60,0,0,-20,-18,0,0]
              },
              '4,7,5,6': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,1,0,0,3,2,0,0],
                'v': [0,33,33,0,0,-27,-27,0,0]
              },
              '5,8,6,7': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,1,1,0,0,2,2,0,0],
                'v': [0,25,25,0,0,-20,-20,0,0]
              }
            }
          }, 
          '20240405_203410': {
            'a': [1, 2, 3, 4, 5],
            'b': [4, 5, 6, 7, 8],
            'm': [2, 3, 4, 5, 6],
            'n': [3, 4, 5, 6, 7],
            'r': [3.3, 4.4, 3.1, 4.2, -0.2],
            'i': [12.2, 4.3, 2.2, 11, 14.2],
            'v': [1250, 400, 500, 2413, 3500],
            'dev': [0.01, 0.03, 0.03, 0.1, 0.2],
            'fw': {
              '1,4,2,3': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,2,0,0,2,2,0,0],
                'v': [0,30,30,0,0,-27,-27,0,0]
              },
              '2,5,3,4': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,4,4,0,0,4,4,0,0],
                'v': [0,40,40,0,0,-90,-90,0,0]
              },
              '3,6,4,5': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,2,0,0,3,3,0,0],
                'v': [0,60,60,0,0,-20,-18,0,0]
              },
              '4,7,5,6': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,1,0,0,3,2,0,0],
                'v': [0,35,35,0,0,-27,-27,0,0]
              },
              '5,8,6,7': {
                't': [1,2,3,4,5,6,7,8,9],
                'i': [0,2,2,0,0,2,2,0,0],
                'v': [0,25,25,0,0,-24,-24,0,0]
              }
            }
          }
        }
      }
      //processData(ddic2)

      /* TODO
      - read from data_log instead of getData()?
      */
    </script>

    <!-- Boostrap scripts (at the end of the page for faster loading time)-->
    <script src="js/bootstrap.bundle.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script> -->
</body>

</html>